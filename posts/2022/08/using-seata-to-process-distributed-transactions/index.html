<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> 使用 Seata 处理分布式事务 | Norwegian Wood</title>
  <link rel='canonical' href='https://akynazh.site/posts/2022/08/using-seata-to-process-distributed-transactions/'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="使用 Seata 处理分布式事务" />
<meta property="og:description" content="关于分布式事务 ​分布式系统会把一个应用系统拆分为可独立部署的多个服务，因此需要服务与服务之间远程协作才能完成事务操作。
这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为分布式事务。
例如用户下一个订单，需要首先创建订单，然后删减库存，接着扣除用户的金钱，最后完成订单。这个过程中，每个操作都可以作为一个微服务，每个微服务操作对应的数据库，而各个数据库可能分布在不同机器上，那么分布式事务就产生了，我们要确保一个事务被正确地处理，必须解决好分布式事务的数据提交与回滚。
关于Seata Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。（来源官网）
TC (Transaction Coordinator) - 事务协调者：
维护全局和分支事务的状态，驱动全局事务提交或回滚。
TM (Transaction Manager) - 事务管理器：
定义全局事务的范围：开始全局事务、提交或回滚全局事务。
RM (Resource Manager) - 资源管理器：
管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
开始编码测试 架构说明 开启三个微服务，创建订单服务，删减库存服务，扣除用户金钱服务，均注册到nacos。
由订单服务作为入口，首先创建订单，然后删减库存，最后扣钱，完成订单，各个服务数据存取操作均处于不同数据库中。
使用seata作为分布式事务解决方案，也注册到nacos中。
配置Seata环境 一、下载Seata1.0.0
二、建seata表，sql链接
三、修改配置
(1) registry.conf:
type修改为nacos
1registry { 2 # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa 3 type = &#34;nacos&#34; 4 5 nacos { 6 serverAddr = &#34;localhost:8848&#34; 7 namespace = &#34;&#34; 8 cluster = &#34;default&#34; 9 } 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://akynazh.site/posts/2022/08/using-seata-to-process-distributed-transactions/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-09T21:41:53+08:00" />
<meta property="article:modified_time" content="2022-08-09T21:41:53+08:00" /><meta property="og:site_name" content="Norwegian Wood" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 Seata 处理分布式事务"/>
<meta name="twitter:description" content="关于分布式事务 ​分布式系统会把一个应用系统拆分为可独立部署的多个服务，因此需要服务与服务之间远程协作才能完成事务操作。
这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为分布式事务。
例如用户下一个订单，需要首先创建订单，然后删减库存，接着扣除用户的金钱，最后完成订单。这个过程中，每个操作都可以作为一个微服务，每个微服务操作对应的数据库，而各个数据库可能分布在不同机器上，那么分布式事务就产生了，我们要确保一个事务被正确地处理，必须解决好分布式事务的数据提交与回滚。
关于Seata Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。（来源官网）
TC (Transaction Coordinator) - 事务协调者：
维护全局和分支事务的状态，驱动全局事务提交或回滚。
TM (Transaction Manager) - 事务管理器：
定义全局事务的范围：开始全局事务、提交或回滚全局事务。
RM (Resource Manager) - 资源管理器：
管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
开始编码测试 架构说明 开启三个微服务，创建订单服务，删减库存服务，扣除用户金钱服务，均注册到nacos。
由订单服务作为入口，首先创建订单，然后删减库存，最后扣钱，完成订单，各个服务数据存取操作均处于不同数据库中。
使用seata作为分布式事务解决方案，也注册到nacos中。
配置Seata环境 一、下载Seata1.0.0
二、建seata表，sql链接
三、修改配置
(1) registry.conf:
type修改为nacos
1registry { 2 # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa 3 type = &#34;nacos&#34; 4 5 nacos { 6 serverAddr = &#34;localhost:8848&#34; 7 namespace = &#34;&#34; 8 cluster = &#34;default&#34; 9 } 10."/>


  
  
  
  
  

  
  
  
    <input value="dark" id="theme-current" style="display: none;">
    <link id="theme" rel="stylesheet" href="https://akynazh.site/css/styles_dark.css">
  
  <input value="https://akynazh.site/css/styles_dark.css" id="styles-dark" style="display: none;">
  <input value="https://akynazh.site/css/styles_light.css" id="styles-light" style="display: none;">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  
  <link rel="icon" type="image/png" href="/image/base/favicon.ico" />

  
  
</head>
<body class="max-width-blog mx-auto px3 ltr">
  <div class="content index py4">
  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href="https://akynazh.site/posts/2022/08/sentinel-usage-record/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://akynazh.site/posts/2022/08/sekiro-memoir/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Search" id="searchBtn">
            <i class="fa fa-search" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a class="icon" id="theme-change"><i class="fas fa-adjust"></i></a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share" onclick="$('#share').toggle();return false;">
            <i class="fas fa-share-alt" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-search" class="info" style="display:none;">Search</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&text=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&is_video=false&description=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1&body=Check out this article: https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&name=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1&description=%e5%85%b3%e4%ba%8e%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%20%e2%80%8b%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e4%bc%9a%e6%8a%8a%e4%b8%80%e4%b8%aa%e5%ba%94%e7%94%a8%e7%b3%bb%e7%bb%9f%e6%8b%86%e5%88%86%e4%b8%ba%e5%8f%af%e7%8b%ac%e7%ab%8b%e9%83%a8%e7%bd%b2%e7%9a%84%e5%a4%9a%e4%b8%aa%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%9b%a0%e6%ad%a4%e9%9c%80%e8%a6%81%e6%9c%8d%e5%8a%a1%e4%b8%8e%e6%9c%8d%e5%8a%a1%e4%b9%8b%e9%97%b4%e8%bf%9c%e7%a8%8b%e5%8d%8f%e4%bd%9c%e6%89%8d%e8%83%bd%e5%ae%8c%e6%88%90%e4%ba%8b%e5%8a%a1%e6%93%8d%e4%bd%9c%e3%80%82%0a%e8%bf%99%e7%a7%8d%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e7%8e%af%e5%a2%83%e4%b8%8b%e7%94%b1%e4%b8%8d%e5%90%8c%e7%9a%84%e6%9c%8d%e5%8a%a1%e4%b9%8b%e9%97%b4%e9%80%9a%e8%bf%87%e7%bd%91%e7%bb%9c%e8%bf%9c%e7%a8%8b%e5%8d%8f%e4%bd%9c%e5%ae%8c%e6%88%90%e4%ba%8b%e5%8a%a1%e7%a7%b0%e4%b9%8b%e4%b8%ba%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e3%80%82%0a%e4%be%8b%e5%a6%82%e7%94%a8%e6%88%b7%e4%b8%8b%e4%b8%80%e4%b8%aa%e8%ae%a2%e5%8d%95%ef%bc%8c%e9%9c%80%e8%a6%81%e9%a6%96%e5%85%88%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%ef%bc%8c%e6%8e%a5%e7%9d%80%e6%89%a3%e9%99%a4%e7%94%a8%e6%88%b7%e7%9a%84%e9%87%91%e9%92%b1%ef%bc%8c%e6%9c%80%e5%90%8e%e5%ae%8c%e6%88%90%e8%ae%a2%e5%8d%95%e3%80%82%e8%bf%99%e4%b8%aa%e8%bf%87%e7%a8%8b%e4%b8%ad%ef%bc%8c%e6%af%8f%e4%b8%aa%e6%93%8d%e4%bd%9c%e9%83%bd%e5%8f%af%e4%bb%a5%e4%bd%9c%e4%b8%ba%e4%b8%80%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%ef%bc%8c%e6%af%8f%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%93%8d%e4%bd%9c%e5%af%b9%e5%ba%94%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%ef%bc%8c%e8%80%8c%e5%90%84%e4%b8%aa%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8f%af%e8%83%bd%e5%88%86%e5%b8%83%e5%9c%a8%e4%b8%8d%e5%90%8c%e6%9c%ba%e5%99%a8%e4%b8%8a%ef%bc%8c%e9%82%a3%e4%b9%88%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e5%b0%b1%e4%ba%a7%e7%94%9f%e4%ba%86%ef%bc%8c%e6%88%91%e4%bb%ac%e8%a6%81%e7%a1%ae%e4%bf%9d%e4%b8%80%e4%b8%aa%e4%ba%8b%e5%8a%a1%e8%a2%ab%e6%ad%a3%e7%a1%ae%e5%9c%b0%e5%a4%84%e7%90%86%ef%bc%8c%e5%bf%85%e9%a1%bb%e8%a7%a3%e5%86%b3%e5%a5%bd%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e7%9a%84%e6%95%b0%e6%8d%ae%e6%8f%90%e4%ba%a4%e4%b8%8e%e5%9b%9e%e6%bb%9a%e3%80%82%0a%e5%85%b3%e4%ba%8eSeata%20Seata%20%e6%98%af%e4%b8%80%e6%ac%be%e5%bc%80%e6%ba%90%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%ef%bc%8c%e8%87%b4%e5%8a%9b%e4%ba%8e%e6%8f%90%e4%be%9b%e9%ab%98%e6%80%a7%e8%83%bd%e5%92%8c%e7%ae%80%e5%8d%95%e6%98%93%e7%94%a8%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%9c%8d%e5%8a%a1%e3%80%82Seata%20%e5%b0%86%e4%b8%ba%e7%94%a8%e6%88%b7%e6%8f%90%e4%be%9b%e4%ba%86%20AT%e3%80%81TCC%e3%80%81SAGA%20%e5%92%8c%20XA%20%e4%ba%8b%e5%8a%a1%e6%a8%a1%e5%bc%8f%ef%bc%8c%e4%b8%ba%e7%94%a8%e6%88%b7%e6%89%93%e9%80%a0%e4%b8%80%e7%ab%99%e5%bc%8f%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e3%80%82%ef%bc%88%e6%9d%a5%e6%ba%90%e5%ae%98%e7%bd%91%ef%bc%89%0aTC%20%28Transaction%20Coordinator%29%20-%20%e4%ba%8b%e5%8a%a1%e5%8d%8f%e8%b0%83%e8%80%85%ef%bc%9a%0a%e7%bb%b4%e6%8a%a4%e5%85%a8%e5%b1%80%e5%92%8c%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e7%9a%84%e7%8a%b6%e6%80%81%ef%bc%8c%e9%a9%b1%e5%8a%a8%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e3%80%82%0aTM%20%28Transaction%20Manager%29%20-%20%e4%ba%8b%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8%ef%bc%9a%0a%e5%ae%9a%e4%b9%89%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e7%9a%84%e8%8c%83%e5%9b%b4%ef%bc%9a%e5%bc%80%e5%a7%8b%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e3%80%81%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e3%80%82%0aRM%20%28Resource%20Manager%29%20-%20%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e5%99%a8%ef%bc%9a%0a%e7%ae%a1%e7%90%86%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e5%a4%84%e7%90%86%e7%9a%84%e8%b5%84%e6%ba%90%ef%bc%8c%e4%b8%8eTC%e4%ba%a4%e8%b0%88%e4%bb%a5%e6%b3%a8%e5%86%8c%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e5%92%8c%e6%8a%a5%e5%91%8a%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e7%9a%84%e7%8a%b6%e6%80%81%ef%bc%8c%e5%b9%b6%e9%a9%b1%e5%8a%a8%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e3%80%82%0a%e5%bc%80%e5%a7%8b%e7%bc%96%e7%a0%81%e6%b5%8b%e8%af%95%20%e6%9e%b6%e6%9e%84%e8%af%b4%e6%98%8e%20%e5%bc%80%e5%90%af%e4%b8%89%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%e6%9c%8d%e5%8a%a1%ef%bc%8c%e6%89%a3%e9%99%a4%e7%94%a8%e6%88%b7%e9%87%91%e9%92%b1%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%9d%87%e6%b3%a8%e5%86%8c%e5%88%b0nacos%e3%80%82%0a%e7%94%b1%e8%ae%a2%e5%8d%95%e6%9c%8d%e5%8a%a1%e4%bd%9c%e4%b8%ba%e5%85%a5%e5%8f%a3%ef%bc%8c%e9%a6%96%e5%85%88%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%ef%bc%8c%e6%9c%80%e5%90%8e%e6%89%a3%e9%92%b1%ef%bc%8c%e5%ae%8c%e6%88%90%e8%ae%a2%e5%8d%95%ef%bc%8c%e5%90%84%e4%b8%aa%e6%9c%8d%e5%8a%a1%e6%95%b0%e6%8d%ae%e5%ad%98%e5%8f%96%e6%93%8d%e4%bd%9c%e5%9d%87%e5%a4%84%e4%ba%8e%e4%b8%8d%e5%90%8c%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%ad%e3%80%82%0a%e4%bd%bf%e7%94%a8seata%e4%bd%9c%e4%b8%ba%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%ef%bc%8c%e4%b9%9f%e6%b3%a8%e5%86%8c%e5%88%b0nacos%e4%b8%ad%e3%80%82%0a%e9%85%8d%e7%bd%aeSeata%e7%8e%af%e5%a2%83%20%e4%b8%80%e3%80%81%e4%b8%8b%e8%bd%bdSeata1.0.0%0a%e4%ba%8c%e3%80%81%e5%bb%baseata%e8%a1%a8%ef%bc%8csql%e9%93%be%e6%8e%a5%0a%e4%b8%89%e3%80%81%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%0a%281%29%20registry.conf%3a%0atype%e4%bf%ae%e6%94%b9%e4%b8%banacos%0a1registry%20%7b%202%20%23%20file%20%e3%80%81nacos%20%e3%80%81eureka%e3%80%81redis%e3%80%81zk%e3%80%81consul%e3%80%81etcd3%e3%80%81sofa%203%20type%20%3d%20%26%2334%3bnacos%26%2334%3b%204%205%20nacos%20%7b%206%20serverAddr%20%3d%20%26%2334%3blocalhost%3a8848%26%2334%3b%207%20namespace%20%3d%20%26%2334%3b%26%2334%3b%208%20cluster%20%3d%20%26%2334%3bdefault%26%2334%3b%209%20%7d%2010." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&t=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#关于分布式事务">关于分布式事务</a></li>
    <li><a href="#关于seata">关于Seata</a></li>
    <li><a href="#开始编码测试">开始编码测试</a>
      <ul>
        <li><a href="#架构说明">架构说明</a></li>
        <li><a href="#配置seata环境">配置Seata环境</a></li>
        <li><a href="#编写微服务模块">编写微服务模块</a>
          <ul>
            <li><a href="#一创建数据库表">一、创建数据库表：</a></li>
            <li><a href="#二微服务配置">二、微服务配置：</a></li>
            <li><a href="#三多数据源配置">三、多数据源配置</a></li>
            <li><a href="#微服务代码编写">微服务代码编写</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#测试">测试</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>
  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        使用 Seata 处理分布式事务
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-08-09 21:41:53 &#43;0800 CST" itemprop="datePublished">2022-08-09</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          9 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/web">Web</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/springcloud" rel="tag">springcloud</a>
            
             ,  
            <a class="tag-link" href="/tags/microservice" rel="tag">microservice</a>
            
        </div>
        
      </div>
    </header>
    
    <div class="content" itemprop="articleBody">
      <h2 id="关于分布式事务">关于分布式事务</h2>
<p>​分布式系统会把一个应用系统拆分为可独立部署的多个服务，因此需要服务与服务之间远程协作才能完成事务操作。</p>
<p>这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为分布式事务。</p>
<p>例如用户下一个订单，需要首先创建订单，然后删减库存，接着扣除用户的金钱，最后完成订单。这个过程中，每个操作都可以作为一个微服务，每个微服务操作对应的数据库，而各个数据库可能分布在不同机器上，那么分布式事务就产生了，我们要确保一个事务被正确地处理，必须解决好分布式事务的数据提交与回滚。</p>
<h2 id="关于seata">关于Seata</h2>
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。（来源官网）</p>
<p><img src="image/1.png" alt=""></p>
<ul>
<li>
<p>TC (Transaction Coordinator) - 事务协调者：</p>
<p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
</li>
<li>
<p>TM (Transaction Manager) - 事务管理器：</p>
<p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
</li>
<li>
<p>RM (Resource Manager) - 资源管理器：</p>
<p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
</li>
</ul>
<h2 id="开始编码测试">开始编码测试</h2>
<h3 id="架构说明">架构说明</h3>
<p>开启三个微服务，创建订单服务，删减库存服务，扣除用户金钱服务，均注册到nacos。</p>
<p>由订单服务作为入口，首先创建订单，然后删减库存，最后扣钱，完成订单，各个服务数据存取操作均处于不同数据库中。</p>
<p>使用seata作为分布式事务解决方案，也注册到nacos中。</p>
<h3 id="配置seata环境">配置Seata环境</h3>
<p>一、下载Seata1.0.0</p>
<p>二、建seata表，<a href="https://github.com/seata/seata/blob/develop/script/server/db/mysql.sql">sql链接</a></p>
<p>三、修改配置</p>
<p>(1) registry.conf:</p>
<p>type修改为nacos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>registry {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  type = &#34;nacos&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  nacos {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    serverAddr = &#34;localhost:8848&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    namespace = &#34;&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    cluster = &#34;default&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>(2) file.conf:</p>
<p>my_test_tx_group修改为自定义group名，store.mode改为db，修改db配置内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>service {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  #transaction service group mapping
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  vgroup_mapping.jzh = &#34;default&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  #only support when registry.type=file, please don&#39;t set multiple addresses
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  default.grouplist = &#34;127.0.0.1:8091&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>  #disable seata
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  disableGlobalTransaction = false
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>## transaction log store, only used in seata-server
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>store {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  ## store mode: file、db
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  mode = &#34;db&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>  ## file store property
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>  file {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    ## store location dir
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    dir = &#34;sessionStore&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>  ## database store property
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>  db {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    datasource = &#34;dbcp&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    ## mysql/oracle/h2/oceanbase etc.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    db-type = &#34;mysql&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    driver-class-name = &#34;com.mysql.jdbc.Driver&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    url = &#34;jdbc:mysql://127.0.0.1:3306/seata&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    user = &#34;root&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>    password = &#34;******&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>}
</span></span></code></pre></div><p>四、启动seata</p>
<p>bin目录下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>.\seata-server.bat -p 8091 -h 127.0.0.1 -m db
</span></span></code></pre></div><h3 id="编写微服务模块">编写微服务模块</h3>
<h4 id="一创建数据库表">一、创建数据库表：</h4>
<p>创建seata_order，seata_account，seata_storage三个数据库，创建对应数据表，以及undo_log表，<a href="https://github.com/seata/seata/blob/develop/script/client/at/db/mysql.sql">数据库脚本地址</a>。</p>
<h4 id="二微服务配置">二、微服务配置：</h4>
<p>将file.conf和registry.conf复制到微服务对应配置文件目录下。</p>
<p>在application.yaml指明自定义的服务组。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">spring</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#ff79c6">cloud</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#ff79c6">alibaba</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      <span style="color:#ff79c6">seata</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        <span style="color:#ff79c6">tx-service-group</span>: jzh
</span></span></code></pre></div><p>导入seata依赖（指定好自己用的seata版本）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#ff79c6">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-seata<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#ff79c6">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#ff79c6">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>seata-all<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>io.seata<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#ff79c6">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#ff79c6">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#ff79c6">&lt;groupId&gt;</span>io.seata<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#ff79c6">&lt;artifactId&gt;</span>seata-all<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#ff79c6">&lt;version&gt;</span>1.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="三多数据源配置">三、多数据源配置</h4>
<p>seata需要处理多个数据源，因此必须配置多数据源，然而DataSourceAutoConfiguration.class默认会帮我们自动配置单数据源，所以必须排除它。</p>
<p>启动类添加如下注解即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>@SpringBootApplication<span style="color:#ff79c6">(</span>exclude <span style="color:#ff79c6">=</span> DataSourceAutoConfiguration<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>同时指定多数据源配置如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Configuration
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">DataSourceProxyConfig</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    @Bean
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    @ConfigurationProperties<span style="color:#ff79c6">(</span>prefix <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;spring.datasource&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> DataSource <span style="color:#50fa7b">druidDataSource</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DruidDataSource<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    @Bean
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> DataSourceProxy <span style="color:#50fa7b">dataSourceProxy</span><span style="color:#ff79c6">(</span>DataSource dataSource<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DataSourceProxy<span style="color:#ff79c6">(</span>dataSource<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    @Bean
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> SqlSessionFactory <span style="color:#50fa7b">sqlSessionFactoryBean</span><span style="color:#ff79c6">(</span>DataSourceProxy dataSourceProxy<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        SqlSessionFactoryBean sqlSessionFactoryBean <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> SqlSessionFactoryBean<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        sqlSessionFactoryBean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setDataSource</span><span style="color:#ff79c6">(</span>dataSourceProxy<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        sqlSessionFactoryBean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setMapperLocations</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> PathMatchingResourcePatternResolver<span style="color:#ff79c6">().</span><span style="color:#50fa7b">getResources</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;classpath:mapper/*.xml&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        sqlSessionFactoryBean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setTransactionFactory</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> SpringManagedTransactionFactory<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#ff79c6">return</span> sqlSessionFactoryBean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h4 id="微服务代码编写">微服务代码编写</h4>
<p>订单服务具体实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Service
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>@Slf4j
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">OrderServiceImpl</span> <span style="color:#8be9fd;font-style:italic">implements</span> OrderService <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    @Override
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    @GlobalTransactional<span style="color:#ff79c6">(</span>name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;jzh-create&#34;</span><span style="color:#ff79c6">,</span> rollbackFor <span style="color:#ff79c6">=</span> Exception<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">create</span><span style="color:#ff79c6">(</span>Order order<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************开始创建订单&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        orderDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">create</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************开始扣库存&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        storageService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decrease</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProductId</span><span style="color:#ff79c6">(),</span> order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getCount</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************完成扣库存&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************开始扣钱&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        accountService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decrease</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUserId</span><span style="color:#ff79c6">(),</span> order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMoney</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************扣钱完成&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        orderDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">update</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUserId</span><span style="color:#ff79c6">(),</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;************订单完成&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    @Resource
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> OrderDao orderDao<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    @Resource
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> StorageService storageService<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    @Resource
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> AccountService accountService<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>rollbackFor指定为任何异常发生都回滚。</p>
<p>其他两个微服务通过feign调用：</p>
<p>AccountService.java:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>@FeignClient<span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;seata-account-service&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">AccountService</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    @PostMapping<span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/account/decrease&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    CommonResult <span style="color:#50fa7b">decrease</span><span style="color:#ff79c6">(</span>@RequestParam<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;userId&#34;</span><span style="color:#ff79c6">)</span> Long userId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>                          @RequestParam<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;money&#34;</span><span style="color:#ff79c6">)</span> BigDecimal money<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>StorageService.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>@FeignClient<span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;seata-storage-service&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">StorageService</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    @PostMapping<span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/storage/decrease&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    CommonResult <span style="color:#50fa7b">decrease</span><span style="color:#ff79c6">(</span>@RequestParam<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;productId&#34;</span><span style="color:#ff79c6">)</span> Long productId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>                          @RequestParam<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;count&#34;</span><span style="color:#ff79c6">)</span> Integer count<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>其他两个微服务具体代码省略了。</p>
<p>OrderController:</p>
<p>通过/order/create请求服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@RestController
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>@Slf4j
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">OrderController</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    @Resource
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> OrderService orderService<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    @PostMapping<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/order/create&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> CommonResult <span style="color:#50fa7b">create</span><span style="color:#ff79c6">(</span>@RequestBody Order order<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        orderService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">create</span><span style="color:#ff79c6">(</span>order<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> CommonResult<span style="color:#ff79c6">(</span><span style="color:#bd93f9">200</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;订单创建成功&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="测试">测试</h2>
<p>一、访问<code>localhost:8848/nacos</code>，发现三个微服务和seata服务都已经注册成功；</p>
<p>二、发送<code>localhost:2001/order/create</code>请求（POST，请求体为订单信息），返回200，查看数据库表，数据变更正确；</p>
<p>三、手动给Account服务添加除0异常，重复如上请求，返回500，后台报异常，查看库存数据库表，发现存量没有变化，证明回滚成功。</p>

    </div>
  </article>
  
  




  <div class="blog-post-comments">
    
      <div id="disquss_thread">
  <script src="https://utteranc.es/client.js"
    repo="akynazh/hugo-comment"
    issue-term="pathname"
    label="akynazh"
    theme="github-dark"
    crossorigin="anonymous"
    async>
  </script>
</div>
    
  </div>


    
    <div id="fastSearch">
      <input id="searchInput" tabindex="0"/>
      <ul id="searchResults"></ul>
    </div>
  <div id="footer-post-container">
  <div id="footer-post">
    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#关于分布式事务">关于分布式事务</a></li>
    <li><a href="#关于seata">关于Seata</a></li>
    <li><a href="#开始编码测试">开始编码测试</a>
      <ul>
        <li><a href="#架构说明">架构说明</a></li>
        <li><a href="#配置seata环境">配置Seata环境</a></li>
        <li><a href="#编写微服务模块">编写微服务模块</a>
          <ul>
            <li><a href="#一创建数据库表">一、创建数据库表：</a></li>
            <li><a href="#二微服务配置">二、微服务配置：</a></li>
            <li><a href="#三多数据源配置">三、多数据源配置</a></li>
            <li><a href="#微服务代码编写">微服务代码编写</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#测试">测试</a></li>
  </ul>
</nav>
    </div>
    
    
    <div id="nav-footer" style="display: none">
      
      <ul style="display:inline;"><li><a href="/">Home</a></li></ul>
      
      <ul style="display:inline;"><li><a href="/posts">Archives</a></li></ul>
      
      <ul style="display:inline;"><li><a href="/about">About</a></li></ul>
      
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&text=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&is_video=false&description=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1&body=Check out this article: https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&title=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&name=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1&description=%e5%85%b3%e4%ba%8e%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%20%e2%80%8b%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e4%bc%9a%e6%8a%8a%e4%b8%80%e4%b8%aa%e5%ba%94%e7%94%a8%e7%b3%bb%e7%bb%9f%e6%8b%86%e5%88%86%e4%b8%ba%e5%8f%af%e7%8b%ac%e7%ab%8b%e9%83%a8%e7%bd%b2%e7%9a%84%e5%a4%9a%e4%b8%aa%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%9b%a0%e6%ad%a4%e9%9c%80%e8%a6%81%e6%9c%8d%e5%8a%a1%e4%b8%8e%e6%9c%8d%e5%8a%a1%e4%b9%8b%e9%97%b4%e8%bf%9c%e7%a8%8b%e5%8d%8f%e4%bd%9c%e6%89%8d%e8%83%bd%e5%ae%8c%e6%88%90%e4%ba%8b%e5%8a%a1%e6%93%8d%e4%bd%9c%e3%80%82%0a%e8%bf%99%e7%a7%8d%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e7%8e%af%e5%a2%83%e4%b8%8b%e7%94%b1%e4%b8%8d%e5%90%8c%e7%9a%84%e6%9c%8d%e5%8a%a1%e4%b9%8b%e9%97%b4%e9%80%9a%e8%bf%87%e7%bd%91%e7%bb%9c%e8%bf%9c%e7%a8%8b%e5%8d%8f%e4%bd%9c%e5%ae%8c%e6%88%90%e4%ba%8b%e5%8a%a1%e7%a7%b0%e4%b9%8b%e4%b8%ba%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e3%80%82%0a%e4%be%8b%e5%a6%82%e7%94%a8%e6%88%b7%e4%b8%8b%e4%b8%80%e4%b8%aa%e8%ae%a2%e5%8d%95%ef%bc%8c%e9%9c%80%e8%a6%81%e9%a6%96%e5%85%88%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%ef%bc%8c%e6%8e%a5%e7%9d%80%e6%89%a3%e9%99%a4%e7%94%a8%e6%88%b7%e7%9a%84%e9%87%91%e9%92%b1%ef%bc%8c%e6%9c%80%e5%90%8e%e5%ae%8c%e6%88%90%e8%ae%a2%e5%8d%95%e3%80%82%e8%bf%99%e4%b8%aa%e8%bf%87%e7%a8%8b%e4%b8%ad%ef%bc%8c%e6%af%8f%e4%b8%aa%e6%93%8d%e4%bd%9c%e9%83%bd%e5%8f%af%e4%bb%a5%e4%bd%9c%e4%b8%ba%e4%b8%80%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%ef%bc%8c%e6%af%8f%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%93%8d%e4%bd%9c%e5%af%b9%e5%ba%94%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%ef%bc%8c%e8%80%8c%e5%90%84%e4%b8%aa%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8f%af%e8%83%bd%e5%88%86%e5%b8%83%e5%9c%a8%e4%b8%8d%e5%90%8c%e6%9c%ba%e5%99%a8%e4%b8%8a%ef%bc%8c%e9%82%a3%e4%b9%88%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e5%b0%b1%e4%ba%a7%e7%94%9f%e4%ba%86%ef%bc%8c%e6%88%91%e4%bb%ac%e8%a6%81%e7%a1%ae%e4%bf%9d%e4%b8%80%e4%b8%aa%e4%ba%8b%e5%8a%a1%e8%a2%ab%e6%ad%a3%e7%a1%ae%e5%9c%b0%e5%a4%84%e7%90%86%ef%bc%8c%e5%bf%85%e9%a1%bb%e8%a7%a3%e5%86%b3%e5%a5%bd%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e7%9a%84%e6%95%b0%e6%8d%ae%e6%8f%90%e4%ba%a4%e4%b8%8e%e5%9b%9e%e6%bb%9a%e3%80%82%0a%e5%85%b3%e4%ba%8eSeata%20Seata%20%e6%98%af%e4%b8%80%e6%ac%be%e5%bc%80%e6%ba%90%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%ef%bc%8c%e8%87%b4%e5%8a%9b%e4%ba%8e%e6%8f%90%e4%be%9b%e9%ab%98%e6%80%a7%e8%83%bd%e5%92%8c%e7%ae%80%e5%8d%95%e6%98%93%e7%94%a8%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%9c%8d%e5%8a%a1%e3%80%82Seata%20%e5%b0%86%e4%b8%ba%e7%94%a8%e6%88%b7%e6%8f%90%e4%be%9b%e4%ba%86%20AT%e3%80%81TCC%e3%80%81SAGA%20%e5%92%8c%20XA%20%e4%ba%8b%e5%8a%a1%e6%a8%a1%e5%bc%8f%ef%bc%8c%e4%b8%ba%e7%94%a8%e6%88%b7%e6%89%93%e9%80%a0%e4%b8%80%e7%ab%99%e5%bc%8f%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e3%80%82%ef%bc%88%e6%9d%a5%e6%ba%90%e5%ae%98%e7%bd%91%ef%bc%89%0aTC%20%28Transaction%20Coordinator%29%20-%20%e4%ba%8b%e5%8a%a1%e5%8d%8f%e8%b0%83%e8%80%85%ef%bc%9a%0a%e7%bb%b4%e6%8a%a4%e5%85%a8%e5%b1%80%e5%92%8c%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e7%9a%84%e7%8a%b6%e6%80%81%ef%bc%8c%e9%a9%b1%e5%8a%a8%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e3%80%82%0aTM%20%28Transaction%20Manager%29%20-%20%e4%ba%8b%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8%ef%bc%9a%0a%e5%ae%9a%e4%b9%89%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e7%9a%84%e8%8c%83%e5%9b%b4%ef%bc%9a%e5%bc%80%e5%a7%8b%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e3%80%81%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e5%85%a8%e5%b1%80%e4%ba%8b%e5%8a%a1%e3%80%82%0aRM%20%28Resource%20Manager%29%20-%20%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e5%99%a8%ef%bc%9a%0a%e7%ae%a1%e7%90%86%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e5%a4%84%e7%90%86%e7%9a%84%e8%b5%84%e6%ba%90%ef%bc%8c%e4%b8%8eTC%e4%ba%a4%e8%b0%88%e4%bb%a5%e6%b3%a8%e5%86%8c%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e5%92%8c%e6%8a%a5%e5%91%8a%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e7%9a%84%e7%8a%b6%e6%80%81%ef%bc%8c%e5%b9%b6%e9%a9%b1%e5%8a%a8%e5%88%86%e6%94%af%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4%e6%88%96%e5%9b%9e%e6%bb%9a%e3%80%82%0a%e5%bc%80%e5%a7%8b%e7%bc%96%e7%a0%81%e6%b5%8b%e8%af%95%20%e6%9e%b6%e6%9e%84%e8%af%b4%e6%98%8e%20%e5%bc%80%e5%90%af%e4%b8%89%e4%b8%aa%e5%be%ae%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%e6%9c%8d%e5%8a%a1%ef%bc%8c%e6%89%a3%e9%99%a4%e7%94%a8%e6%88%b7%e9%87%91%e9%92%b1%e6%9c%8d%e5%8a%a1%ef%bc%8c%e5%9d%87%e6%b3%a8%e5%86%8c%e5%88%b0nacos%e3%80%82%0a%e7%94%b1%e8%ae%a2%e5%8d%95%e6%9c%8d%e5%8a%a1%e4%bd%9c%e4%b8%ba%e5%85%a5%e5%8f%a3%ef%bc%8c%e9%a6%96%e5%85%88%e5%88%9b%e5%bb%ba%e8%ae%a2%e5%8d%95%ef%bc%8c%e7%84%b6%e5%90%8e%e5%88%a0%e5%87%8f%e5%ba%93%e5%ad%98%ef%bc%8c%e6%9c%80%e5%90%8e%e6%89%a3%e9%92%b1%ef%bc%8c%e5%ae%8c%e6%88%90%e8%ae%a2%e5%8d%95%ef%bc%8c%e5%90%84%e4%b8%aa%e6%9c%8d%e5%8a%a1%e6%95%b0%e6%8d%ae%e5%ad%98%e5%8f%96%e6%93%8d%e4%bd%9c%e5%9d%87%e5%a4%84%e4%ba%8e%e4%b8%8d%e5%90%8c%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%ad%e3%80%82%0a%e4%bd%bf%e7%94%a8seata%e4%bd%9c%e4%b8%ba%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%ef%bc%8c%e4%b9%9f%e6%b3%a8%e5%86%8c%e5%88%b0nacos%e4%b8%ad%e3%80%82%0a%e9%85%8d%e7%bd%aeSeata%e7%8e%af%e5%a2%83%20%e4%b8%80%e3%80%81%e4%b8%8b%e8%bd%bdSeata1.0.0%0a%e4%ba%8c%e3%80%81%e5%bb%baseata%e8%a1%a8%ef%bc%8csql%e9%93%be%e6%8e%a5%0a%e4%b8%89%e3%80%81%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%0a%281%29%20registry.conf%3a%0atype%e4%bf%ae%e6%94%b9%e4%b8%banacos%0a1registry%20%7b%202%20%23%20file%20%e3%80%81nacos%20%e3%80%81eureka%e3%80%81redis%e3%80%81zk%e3%80%81consul%e3%80%81etcd3%e3%80%81sofa%203%20type%20%3d%20%26%2334%3bnacos%26%2334%3b%204%205%20nacos%20%7b%206%20serverAddr%20%3d%20%26%2334%3blocalhost%3a8848%26%2334%3b%207%20namespace%20%3d%20%26%2334%3b%26%2334%3b%208%20cluster%20%3d%20%26%2334%3bdefault%26%2334%3b%209%20%7d%2010." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fakynazh.site%2fposts%2f2022%2f08%2fusing-seata-to-process-distributed-transactions%2f&t=%e4%bd%bf%e7%94%a8%20Seata%20%e5%a4%84%e7%90%86%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu-toggle" class="icon-mobile-nav" href="#" onclick="$('#nav-footer').show();$('#toc-footer').hide();$('#share-footer').hide();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i></a>

        
        <a id="toc-toggle"class="icon-mobile-nav"  href="#" onclick="$('#toc-footer').show();$('#nav-footer').hide();$('#share-footer').hide();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i></a>
        

        <a id="top" class="icon-mobile-nav" style="display:none" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i></a>

        <a id="searchBtn1" class="icon-mobile-nav"  href="#" aria-label="Search">
          <i class="fa fa-search fa-lg" aria-hidden="true"></i></a>

        <a id="theme-change" class="icon-mobile-nav"><i class="fas fa-adjust fa-lg"></i></a>

        <a id="share-toggle" class="icon-mobile-nav"  href="#" onclick="$('#share-footer').show();$('#toc-footer').hide();$('#nav-footer').hide();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i></a>
    </div>

  </div>
</div>

  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2023  Jzh 
    | <a href="https://beian.miit.gov.cn/" style="text-decoration:none;">陕ICP备2022007986号-1</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>
  </div>
</body>
<script src="/js/fuse.min.js"></script>
<script src="/js/fastsearch.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/main.js"></script>





</html>
